---
layout: post
title: springMVC 패턴 spriong security_3(JsonAuthenticationFilter)
tags: [spring]
categories: spring
---

- Spring Security(JsonAuthenticationFilter)

> REST API 환경에서는 JSON 본문(body)에 담긴 인증 정보를 가져와야함. 이를 위해 AbstractAuthenticationProcessingFilter를 상속받아 커스텀 필터를 구현하는 방법을 알아보겠다.

> 그래서 Spring Security는 UserDetails 라는 인터페이스를 제공한다. 우리가 만든 UserVO를 이 인터페이스 규격에 맞춰 감싸주면(Wrapping), Security가 이를 인식하여 인증 처리를 수행하게 된다. 일종의 '통역사' 역할을 하는 클래스라고 보면 된다.

> 1. 전체 코드 흐름 보기
> - 이 필터는 사용자가 /auth/signIn 경로로 POST 요청을 보낼 때 동작하며, 흐름은 다음과 같습니다.

```
package co.spring.mvc.security.filter;

import java.io.IOException;

import javax.servlet.ServletException;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import org.codehaus.jackson.map.ObjectMapper;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.AuthenticationException;
import org.springframework.security.web.authentication.AbstractAuthenticationProcessingFilter;
import org.springframework.security.web.util.matcher.AntPathRequestMatcher;

import co.spring.mvc.user.service.UserVO;
public class JsonAuthenticationFilter extends AbstractAuthenticationProcessingFilter {

    public JsonAuthenticationFilter(AuthenticationManager authenticationManager) {
        // 1. 필터가 작동할 URL과 HTTP 메소드를 지정합니다.
        super(new AntPathRequestMatcher("/auth/signIn", "POST")); 
        setAuthenticationManager(authenticationManager);
    }

    @Override
    public Authentication attemptAuthentication(HttpServletRequest request, HttpServletResponse response)
            throws AuthenticationException, IOException, ServletException {
        
        // 2. Jackson ObjectMapper를 사용해 JSON 요청 본문을 객체(UserVO)로 변환합니다.
        ObjectMapper objectMapper = new ObjectMapper();
        UserVO userVO = objectMapper.readValue(request.getInputStream(), UserVO.class);
        
        // (선택사항) 이후 로직에서 활용하기 위해 request 객체에 사용자 아이디를 저장해둡니다.
        request.setAttribute("username", userVO.getUserId());

        // 3. 추출한 아이디와 비밀번호로 인증용 토큰을 생성합니다.
        UsernamePasswordAuthenticationToken authRequest = new UsernamePasswordAuthenticationToken(
                userVO.getUserId(), userVO.getPassword()
        );

        // 4. AuthenticationManager에게 인증 처리를 위임합니다.
        return this.getAuthenticationManager().authenticate(authRequest);
    }
}
```

> 2. 코드 설명
> - AbstractAuthenticationProcessingFilter 상속: Spring Security에서 커스텀 인증 필터를 만들 때 사용하는 추상 클래스입니다. 특정 요청이 들어오면 attemptAuthentication 메소드를 실행하여 인증을 시도.
> - AntPathRequestMatcher : 생성자에서 지정한 /auth/signIn과 POST 방식이 일치할 때만 이 필터가 작동하도록 설정.
> - JSON 파싱 (ObjectMapper) : 기본 필터는 request.getParameter("username") 형식을 사용하지만, JSON은 스트림에서 데이터를 직접 읽음.
> - 인증 위임 토큰(UsernamePasswordAuthenticationToken)을 생성한 뒤 AuthenticationManager에게 넘김. 그러면 매니저는 등록된 UserDetailsService 등을 통해 실제 DB 정보와 대조하여 로그인을 처리.



