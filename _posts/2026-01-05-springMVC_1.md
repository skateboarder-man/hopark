---
layout: post
title: springMVC 패턴 spriong security_1(CustomUserDetails)
tags: [spring]
categories: spring
---

- Spring Security(CustomUserDetails)

> 지난 포스팅에서 Spring Security의 전체적인 구조를 XML 설정을 통해 살펴보았다. 이번에는 Spring Security가 우리 서비스의 사용자 정보를 이해할 수 있도록 변환해주는 CustomUserDetails 클래스를 구현해 보겠다.

- UserDetails란
>  Spring Security는 인증 과정에서 사용자의 아이디, 비밀번호, 권한 등의 정보를 필요로 한다. 하지만 우리가 만든 DB 구조(UserVO)는 프로젝트마다 제각각 다르다.

> 그래서 Spring Security는 UserDetails 라는 인터페이스를 제공한다. 우리가 만든 UserVO를 이 인터페이스 규격에 맞춰 감싸주면(Wrapping), Security가 이를 인식하여 인증 처리를 수행하게 된다. 일종의 '통역사' 역할을 하는 클래스라고 보면 된다.

- CustomUserDetails 전체 코드

```
package co.spring.mvc.security.service;

import java.util.Collection;
import java.util.Collections;
import java.util.List;
import java.util.stream.Collectors;

import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.core.userdetails.UserDetails;

import co.spring.mvc.user.service.UserVO;
import lombok.RequiredArgsConstructor;


@RequiredArgsConstructor
public class CustomUserDetails implements UserDetails{
	
	private static final long serialVersionUID = 1L;
	
	private final UserVO userVo;

	@Override
	public Collection<? extends GrantedAuthority> getAuthorities() {
		 // 실제로는 userVo.getRole() 등의 메서드를 통해 DB에서 권한을 가져와야 합니다.
        // 여기서는 임시로 "ROLE_USER" 권한을 부여합니다. 
		List <String> roles = userVo.getRoles();
		
		if (roles == null) {
            return Collections.emptyList(); // 권한이 없으면 빈 리스트 반환
        }
		
		return roles.stream()
                .map(SimpleGrantedAuthority::new)
                .collect(Collectors.toList());
	}

	@Override
	public String getPassword() {
		// TODO Auto-generated method stub
		return userVo.getPassword();
	}

	@Override
	public String getUsername() {
		// TODO Auto-generated method stub
		return userVo.getUserId();
	}

	@Override
	public boolean isAccountNonExpired() {
		// TODO Auto-generated method stub
		return true; // 만료되지 않음 (필요에 따라 userVo의 상태 필드를 참조하여 구현)
	}

	@Override
	public boolean isAccountNonLocked() {
		// TODO Auto-generated method stub
		return true; // 잠금되지 않음
	}

	@Override
	public boolean isCredentialsNonExpired() {
		// TODO Auto-generated method stub
		return true; // 비밀번호 만료되지 않음
	}

	@Override
	public boolean isEnabled() {
		// TODO Auto-generated method stub
		return "N".equalsIgnoreCase(userVo.getIsDeleted());
	}
	
	public UserVO getUserVo() {
		return userVo;
	}
	
	

}
```

> 코드 설명
> - getAuthorities(): 사용자가 가진 권한(예: ROLE_USER, ROLE_ADMIN)을 Spring Security가 검증할 수 있는 객체 형태로 바꾸어 전달.
> - isEnabled(): 실무에서 매우 유용한 부분. DB의 isDeleted 컬럼을 확인하여, 탈퇴한 회원이 로그인을 시도할 경우 인증을 거부하도록 함.
> - getUserVo(): 인증이 완료된 후 컨트롤러에서 로그인한 사용자의 이름, 이메일 등 추가 정보가 필요할 때 이 메서드를 통해 원본 객체에 접근.


CustomUserDetails는 데이터의 규격을 맞추는 작업이였음. 이제 이 규격에 데이터를 채워 넣어주는 서비스 클래스를 다음 포스팅에서는 설명하겠음.
실제 DB에서 사용자 정보를 조회하여 이 CustomUserDetails를 생성해 주는 UserDetailsService 구현 하겠다.

